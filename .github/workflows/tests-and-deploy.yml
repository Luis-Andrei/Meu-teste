name: Testes Automatizados, Deploy e Performance

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: ğŸ” Rodar testes
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: yourpassword
          POSTGRES_DB: bankdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: ğŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v4

      - name: âš™ï¸ Instalar Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.21

      - name: ğŸ“¦ Instalar dependÃªncias
        run: go mod tidy

      - name: ğŸ§ª Rodar testes com cobertura
        env:
          DB_USER: postgres
          DB_PASS: yourpassword
          DB_NAME: bankdb
          DB_HOST: localhost
        run: |
          go test ./handlers -v -coverprofile=coverage.out

      - name: â˜ï¸ Upload para Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.out
          flags: unittests
          name: codecov-coverage

      - name: ğŸ§ª Testes de IntegraÃ§Ã£o
        run: |
          curl -X GET http://localhost:8080/accounts/1
          curl -X POST http://localhost:8080/accounts/1/deposit -d '{"amount": 200}'

  deploy:
    name: ğŸš€ Deploy
    needs: test
    runs-on: ubuntu-latest
    if: success()  # SÃ³ executa se os testes passarem

    steps:
      - name: ğŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v4

      - name: âš™ï¸ Instalar Vercel CLI
        run: npm install -g vercel

      - name: ğŸ”‘ Configurar Vercel Token
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: vercel login --token $VERCEL_TOKEN

      - name: ğŸš¢ Criar Docker Image
        run: |
          docker build -t bank-server .
          docker tag bank-server luis-andrei/bank-server:latest
          docker push luis-andrei/bank-server:latest

      - name: ğŸš€ Deploy para Vercel
        run: vercel --prod --token ${{ secrets.VERCEL_TOKEN }} --scope luis-andrei

  notify_failure:
    name: âš ï¸ Notificar falha
    if: failure()  # SÃ³ executa se o job 'deploy' falhar
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸš¨ Enviar alerta de falha para Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"ğŸš¨ O Deploy para Vercel falhou! Por favor, verifique!"}' $SLACK_WEBHOOK_URL

      - name: ğŸš¨ Enviar alerta de falha para Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"content": "ğŸš¨ O Deploy para Vercel falhou! Verifique os logs!"}' $DISCORD_WEBHOOK_URL

  performance:
    name: ğŸ‹ï¸ Testes de Performance
    needs: test
    runs-on: ubuntu-latest
    if: success()

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: yourpassword
          POSTGRES_DB: bankdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: ğŸ“¥ Clonar repositÃ³rio
        uses: actions/checkout@v4

      - name: âš™ï¸ Instalar Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.21

      - name: ğŸ“¦ Instalar dependÃªncias
        run: go mod tidy

      - name: ğŸƒâ€â™‚ï¸ Iniciar servidor em background
        env:
          DB_USER: postgres
          DB_PASS: yourpassword
          DB_NAME: bankdb
          DB_HOST: localhost
        run: |
          go run main.go &
          sleep 5  # Espera o servidor iniciar

      - name: âš™ï¸ Instalar k6
        run: |
          sudo apt-get update
          sudo apt-get install -y k6

      - name: ğŸš€ Rodar Teste de Performance com k6
        run: |
          k6 run tests/performance.js 